<div class="dynamic-form-container">
      <header class="page-header">
       
        <div>
          <h1 class="form-title">{{ title }}</h1>
          <p class="form-subtitle" *ngIf="schema.description">{{ schema.description }}</p>
        </div>
        <div class="header-actions">
           <button *ngIf="isEditMode" type="submit" [disabled]="!isFormValid()" mat-raised-button (click)="onSubmit()">
             <mat-icon>save</mat-icon> {{ submitButtonText }}
           </button>
           <button *ngIf="!isEditMode && mode !== 'preview'" type="submit" [disabled]="form.invalid" mat-raised-button (click)="onSubmit()">
             <mat-icon>send</mat-icon> {{ submitButtonText }}
           </button>
        </div>
      </header>

      <!-- Template Indicator Tab -->
      <div *ngIf="templateName && mode === 'use'" class="template-indicator">
        <div class="template-tab-v2 template-tab-horizontal">
          <span class="template-label">You are currently filling:</span>
          <mat-icon class="template-icon">description</mat-icon>
          <span class="template-name">{{ templateName }}</span>
        </div>
      </div>

      <div *ngIf="isLoading" class="loading-spinner">Loading form...</div>

      <main class="form-grid" *ngIf="!isLoading">
        <!-- Left Panel: Form Filling / Preview -->
        <div class="form-panel card" [class.full-width]="!isEditMode">
          <header class="panel-header">
            <h3>{{ isEditMode ? 'Live Preview' : 'Complete the Form' }}</h3>
            <p class="panel-subtitle" *ngIf="isEditMode">This is how your form will look to users.</p>
          </header>
          <form [formGroup]="form" (ngSubmit)="onSubmit()" (click)="showAllErrors($event)">
  <div *ngFor="let field of visibleFields" class="form-field vertical-field" [ngSwitch]="field.type">
    <div class="field-label-vertical">
      <span>{{ field.label }}</span>
      <span *ngIf="isFieldRequired(field)" class="required-asterisk-vertical">*</span>
    </div>
    <div class="field-input-vertical"
         [ngClass]="{'no-line': field.type === 'mcq_multiple' || field.type === 'boolean'}">
      
      <!-- ENVIRONMENT-SPECIFIC FIELDS -->
      <ng-container *ngIf="field.environmentSpecific; else normalField">
        <ng-container *ngIf="form.get(field.key) as envGroup">
          <div [formGroup]="asFormGroup(envGroup)">
            <div class="env-specific-fields">
              <!-- PROD Environment -->
              <div class="env-field">
                <label>{{ field.label }} (PROD)</label>
                <ng-container [ngSwitch]="field.type">
                  <input *ngSwitchCase="'text'" matInput formControlName="PROD" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (PROD)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'number'" matInput type="number" formControlName="PROD" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (PROD)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'email'" matInput type="email" formControlName="PROD" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (PROD)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'timestamp'" matInput type="datetime-local" formControlName="PROD" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <mat-select *ngSwitchCase="'dropdown'" formControlName="PROD" 
                              [disabled]="isReadOnly || !isFieldEditable(field)">
                    <mat-option *ngFor="let opt of field.options" [value]="opt.value">{{ opt.label }}</mat-option>
                  </mat-select>
                  <mat-radio-group *ngSwitchCase="'mcq_single'" formControlName="PROD" 
                                   [disabled]="isReadOnly || !isFieldEditable(field)">
                    <div *ngFor="let opt of field.options">
                      <mat-radio-button [value]="opt.value">{{ opt.label }}</mat-radio-button>
                    </div>
                  </mat-radio-group>
                  <div *ngSwitchCase="'mcq_multiple'">
                    <div *ngFor="let opt of field.options">
                      <mat-checkbox [checked]="envGroup.get('PROD')?.value?.includes(opt.value)"
                                    (change)="onMCQMultiChangeEnv(asFormGroup(envGroup), 'PROD', opt.value, $event.checked)"
                                    [disabled]="isReadOnly || !isFieldEditable(field)">
                        {{ opt.label }}
                      </mat-checkbox>
                    </div>
                  </div>
                  <mat-slide-toggle *ngSwitchCase="'boolean'" formControlName="PROD" 
                                    [disabled]="isReadOnly || !isFieldEditable(field)">
                    {{ field.placeholder || field.label }} (PROD)
                  </mat-slide-toggle>
                  <ng-container *ngSwitchCase="'keyvalue'">
                    <div [formArrayName]="'PROD'">
                      <div *ngFor="let group of getKeyValueArrayEnv(asFormGroup(envGroup), 'PROD')?.controls; let i = index" 
                           [formGroupName]="i" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <mat-form-field appearance="fill" style="flex:1;">
                          <mat-label>Key</mat-label>
                          <input matInput formControlName="key">
                        </mat-form-field>
                        <mat-form-field appearance="fill" style="flex:1;">
                          <mat-label>Value</mat-label>
                          <input matInput formControlName="value">
                        </mat-form-field>
                        <button mat-icon-button color="warn" type="button" 
                                (click)="removeKeyValuePairEnv(asFormGroup(envGroup), 'PROD', i)">
                          <span class="material-icons">delete</span>
                        </button>
                      </div>
                      <button mat-stroked-button color="primary" type="button" 
                              (click)="addKeyValuePairEnv(asFormGroup(envGroup), 'PROD')">+ Add Pair</button>
                    </div>
                  </ng-container>
                  <input *ngSwitchDefault matInput formControlName="PROD" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (PROD)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                </ng-container>
                <!-- Single error message for PROD environment -->
                <div *ngIf="hasEnvFieldError(field.key, 'PROD')" class="error-message">
                  {{ getEnvFieldErrorMessage(field.key, 'PROD') }}
                </div>
              </div>

              <!-- DEV Environment -->
              <div class="env-field">
                <label>{{ field.label }} (DEV)</label>
                <ng-container [ngSwitch]="field.type">
                  <input *ngSwitchCase="'text'" matInput formControlName="DEV" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (DEV)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'number'" matInput type="number" formControlName="DEV" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (DEV)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'email'" matInput type="email" formControlName="DEV" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (DEV)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'timestamp'" matInput type="datetime-local" formControlName="DEV" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <mat-select *ngSwitchCase="'dropdown'" formControlName="DEV" 
                              [disabled]="isReadOnly || !isFieldEditable(field)">
                    <mat-option *ngFor="let opt of field.options" [value]="opt.value">{{ opt.label }}</mat-option>
                  </mat-select>
                  <mat-radio-group *ngSwitchCase="'mcq_single'" formControlName="DEV" 
                                   [disabled]="isReadOnly || !isFieldEditable(field)">
                    <div *ngFor="let opt of field.options">
                      <mat-radio-button [value]="opt.value">{{ opt.label }}</mat-radio-button>
                    </div>
                  </mat-radio-group>
                  <div *ngSwitchCase="'mcq_multiple'">
                    <div *ngFor="let opt of field.options">
                      <mat-checkbox [checked]="envGroup.get('DEV')?.value?.includes(opt.value)"
                                    (change)="onMCQMultiChangeEnv(asFormGroup(envGroup), 'DEV', opt.value, $event.checked)"
                                    [disabled]="isReadOnly || !isFieldEditable(field)">
                        {{ opt.label }}
                      </mat-checkbox>
                    </div>
                  </div>
                  <mat-slide-toggle *ngSwitchCase="'boolean'" formControlName="DEV" 
                                    [disabled]="isReadOnly || !isFieldEditable(field)">
                    {{ field.placeholder || field.label }} (DEV)
                  </mat-slide-toggle>
                  <ng-container *ngSwitchCase="'keyvalue'">
                    <div [formArrayName]="'DEV'">
                      <div *ngFor="let group of getKeyValueArrayEnv(asFormGroup(envGroup), 'DEV')?.controls; let i = index" 
                           [formGroupName]="i" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <mat-form-field appearance="fill" style="flex:1;">
                          <mat-label>Key</mat-label>
                          <input matInput formControlName="key">
                        </mat-form-field>
                        <mat-form-field appearance="fill" style="flex:1;">
                          <mat-label>Value</mat-label>
                          <input matInput formControlName="value">
                        </mat-form-field>
                        <button mat-icon-button color="warn" type="button" 
                                (click)="removeKeyValuePairEnv(asFormGroup(envGroup), 'DEV', i)">
                          <span class="material-icons">delete</span>
                        </button>
                      </div>
                      <button mat-stroked-button color="primary" type="button" 
                              (click)="addKeyValuePairEnv(asFormGroup(envGroup), 'DEV')">+ Add Pair</button>
                    </div>
                  </ng-container>
                  <input *ngSwitchDefault matInput formControlName="DEV" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (DEV)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                </ng-container>
                <!-- Single error message for DEV environment -->
                <div *ngIf="hasEnvFieldError(field.key, 'DEV')" class="error-message">
                  {{ getEnvFieldErrorMessage(field.key, 'DEV') }}
                </div>
              </div>

              <!-- COB Environment -->
              <div class="env-field">
                <label>{{ field.label }} (COB)</label>
                <ng-container [ngSwitch]="field.type">
                  <input *ngSwitchCase="'text'" matInput formControlName="COB" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (COB)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'number'" matInput type="number" formControlName="COB" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (COB)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'email'" matInput type="email" formControlName="COB" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (COB)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <input *ngSwitchCase="'timestamp'" matInput type="datetime-local" formControlName="COB" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                  <mat-select *ngSwitchCase="'dropdown'" formControlName="COB" 
                              [disabled]="isReadOnly || !isFieldEditable(field)">
                    <mat-option *ngFor="let opt of field.options" [value]="opt.value">{{ opt.label }}</mat-option>
                  </mat-select>
                  <mat-radio-group *ngSwitchCase="'mcq_single'" formControlName="COB" 
                                   [disabled]="isReadOnly || !isFieldEditable(field)">
                    <div *ngFor="let opt of field.options">
                      <mat-radio-button [value]="opt.value">{{ opt.label }}</mat-radio-button>
                    </div>
                  </mat-radio-group>
                  <div *ngSwitchCase="'mcq_multiple'">
                    <div *ngFor="let opt of field.options">
                      <mat-checkbox [checked]="envGroup.get('COB')?.value?.includes(opt.value)"
                                    (change)="onMCQMultiChangeEnv(asFormGroup(envGroup), 'COB', opt.value, $event.checked)"
                                    [disabled]="isReadOnly || !isFieldEditable(field)">
                        {{ opt.label }}
                      </mat-checkbox>
                    </div>
                  </div>
                  <mat-slide-toggle *ngSwitchCase="'boolean'" formControlName="COB" 
                                    [disabled]="isReadOnly || !isFieldEditable(field)">
                    {{ field.placeholder || field.label }} (COB)
                  </mat-slide-toggle>
                  <ng-container *ngSwitchCase="'keyvalue'">
                    <div [formArrayName]="'COB'">
                      <div *ngFor="let group of getKeyValueArrayEnv(asFormGroup(envGroup), 'COB')?.controls; let i = index" 
                           [formGroupName]="i" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <mat-form-field appearance="fill" style="flex:1;">
                          <mat-label>Key</mat-label>
                          <input matInput formControlName="key">
                        </mat-form-field>
                        <mat-form-field appearance="fill" style="flex:1;">
                          <mat-label>Value</mat-label>
                          <input matInput formControlName="value">
                        </mat-form-field>
                        <button mat-icon-button color="warn" type="button" 
                                (click)="removeKeyValuePairEnv(asFormGroup(envGroup), 'COB', i)">
                          <span class="material-icons">delete</span>
                        </button>
                      </div>
                      <button mat-stroked-button color="primary" type="button" 
                              (click)="addKeyValuePairEnv(asFormGroup(envGroup), 'COB')">+ Add Pair</button>
                    </div>
                  </ng-container>
                  <input *ngSwitchDefault matInput formControlName="COB" 
                         [placeholder]="field.placeholder || 'Enter ' + field.label + ' (COB)'" 
                         [readonly]="isReadOnly || !isFieldEditable(field)" />
                </ng-container>
                <!-- Single error message for COB environment -->
                <div *ngIf="hasEnvFieldError(field.key, 'COB')" class="error-message">
                  {{ getEnvFieldErrorMessage(field.key, 'COB') }}
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- NORMAL FIELDS (NON-ENVIRONMENT SPECIFIC) -->
      <ng-template #normalField>
        <ng-container [ngSwitch]="field.type">
          <input *ngSwitchCase="'text'" matInput [formControlName]="field.key" 
                 [placeholder]="field.placeholder || 'Enter ' + field.label" 
                 [readonly]="isReadOnly || !isFieldEditable(field)" 
                 class="input-vertical modern-placeholder" />
          
          <input *ngSwitchCase="'number'" matInput type="number" [formControlName]="field.key" 
                 [placeholder]="field.placeholder || 'Enter ' + field.label" 
                 [readonly]="isReadOnly || !isFieldEditable(field)" 
                 class="input-vertical modern-placeholder" />
          
          <input *ngSwitchCase="'email'" matInput type="email" [formControlName]="field.key" 
                 [placeholder]="field.placeholder || 'Enter ' + field.label" 
                 [readonly]="isReadOnly || !isFieldEditable(field)" 
                 class="input-vertical modern-placeholder" />
          
          <input *ngSwitchCase="'timestamp'" matInput type="datetime-local" [formControlName]="field.key" 
                 [readonly]="isReadOnly || !isFieldEditable(field)" 
                 class="input-vertical modern-placeholder" />
          
          <mat-select *ngSwitchCase="'dropdown'" [formControlName]="field.key" 
                      [disabled]="isReadOnly || !isFieldEditable(field)" 
                      [placeholder]="field.placeholder || ''" class="input-vertical">
            <mat-option *ngFor="let opt of field.options" [value]="opt.value">{{ opt.label }}</mat-option>
          </mat-select>
          
          <mat-radio-group *ngSwitchCase="'mcq_single'" [formControlName]="field.key" 
                           [disabled]="isReadOnly || !isFieldEditable(field)" 
                           class="input-vertical mcq-options-vertical">
            <div *ngFor="let opt of field.options">
              <mat-radio-button [value]="opt.value">{{ opt.label }}</mat-radio-button>
            </div>
          </mat-radio-group>
          
          <div *ngSwitchCase="'mcq_multiple'" class="mcq-multi-options input-vertical mcq-options-vertical">
            <div *ngFor="let opt of field.options" style="width: 100%;">
              <div style="display: flex; align-items: center;">
                <mat-checkbox [checked]="form.get(field.key)?.value?.includes(opt.value)"
                              (change)="onMCQMultiChange(field.key, opt.value, getCheckboxChecked($event))"
                              [disabled]="isReadOnly || !isFieldEditable(field)">
                  {{ opt.label }}
                </mat-checkbox>
              </div>
            </div>
          </div>
          
          <mat-slide-toggle *ngSwitchCase="'boolean'" [formControlName]="field.key" 
                            [disabled]="isReadOnly || !isFieldEditable(field)" 
                            class="input-vertical">{{ field.placeholder || field.label }}</mat-slide-toggle>
          
          <ng-container *ngSwitchCase="'keyvalue'">
            <div [formArrayName]="field.key">
              <div *ngFor="let group of getKeyValueArray(field.key)?.controls; let i = index" 
                   [formGroupName]="i" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                <mat-form-field appearance="fill" style="flex:1;">
                  <mat-label>Key</mat-label>
                  <input matInput formControlName="key">
                </mat-form-field>
                <mat-form-field appearance="fill" style="flex:1;">
                  <mat-label>Value</mat-label>
                  <input matInput formControlName="value">
                </mat-form-field>
                <button mat-icon-button color="warn" type="button" (click)="removeKeyValuePair(field.key, i)">
                  <span class="material-icons">delete</span>
                </button>
              </div>
              <button mat-stroked-button color="primary" type="button" (click)="addKeyValuePair(field.key)">
                + Add Pair
              </button>
            </div>
          </ng-container>
        </ng-container>
        
        <!-- Single consolidated error message for normal fields -->
        <div *ngIf="hasFieldError(field.key)" class="error-message">
          {{ getFieldErrorMessage(field.key) }}
        </div>
      </ng-template>
    </div>
  </div>
  <!-- Submit buttons remain the same -->
  <div class="form-submit-bottom">
    <button *ngIf="isEditMode" type="submit" [disabled]="!isFormValid()" mat-raised-button color="primary">
      <mat-icon>save</mat-icon> {{ submitButtonText }}
    </button>
    <button *ngIf="!isEditMode && mode !== 'preview'" type="submit" [disabled]="form.invalid" mat-raised-button color="accent">
      <mat-icon>send</mat-icon> {{ submitButtonText }}
    </button>
  </div>
</form>
        </div>

        <!-- Right Panel: Template Schema Editor -->
        <div class="schema-editor-panel card" *ngIf="isEditMode">
           <header class="panel-header">
            <h3>Schema Editor</h3>
            <p class="panel-subtitle">Define the structure of your form.</p>
          </header>
          
          <div *ngIf="isLoading" class="schema-loading">
            <div class="loading-spinner">
              <mat-icon class="spinning">refresh</mat-icon>
              <p>Loading template data...</p>
            </div>
          </div>
          
          <div *ngIf="!isLoading">
            <div *ngIf="mode === 'create'" class="import-template-bar">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Import Existing Template</mat-label>
                <input #templateInput type="text" matInput [formControl]="templateSearchCtrl" [matAutocomplete]="auto" placeholder="Search or select template" (focus)="openAutocomplete()">
                <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onImportTemplateChange($event.option.value)">
                  <mat-option [value]="null">-- None --</mat-option>
                  <mat-option *ngFor="let t of filteredTemplates$ | async" [value]="t.name">
                    <span [innerHTML]="highlightMatch(t.name, templateSearchCtrl.value)"></span>
                    <span class="template-author">&nbsp;by {{ t.author || 'Unknown' }}</span>
                    <div class="template-description">{{ t.description }}</div>
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
              <button *ngIf="isImporting" mat-stroked-button color="warn" (click)="clearImportedTemplate()">
                <mat-icon>clear</mat-icon> Clear Template
              </button>
            </div>
            <div class="form-field">
              <label>Template Name</label>
              <input [(ngModel)]="schema.name" placeholder="A unique name for this template" [ngModelOptions]="{standalone: true}" [disabled]="mode === 'edit'">
            </div>
            <div class="form-field">
              <label>Template Description</label>
              <input [(ngModel)]="schema.description" placeholder="A short description of the form's purpose" [ngModelOptions]="{standalone: true}">
            </div>
            <div class="form-field">
              <label>Author Name</label>
              <input [(ngModel)]="schema.author" placeholder="Author of this template" [ngModelOptions]="{standalone: true}">
            </div>
            <div class="form-field">
              <label>Team Name</label>
              <input [(ngModel)]="schema.team_name" placeholder="Enter team name" [ngModelOptions]="{standalone: true}">
              <small class="field-help">Enter the team name. Team name is required.</small>
            </div>
            <div class="form-field">
              <label>Audit Pipeline</label>
              <input [(ngModel)]="schema.audit_pipeline" placeholder="Enter audit pipeline name" [ngModelOptions]="{standalone: true}" required>
              <small class="field-help">This field is mandatory.</small>
            </div>
            <div class="form-field">
              <label>Version Tag</label>
              <input [(ngModel)]="schema.version" placeholder="e.g., v1.0, beta, stable" [ngModelOptions]="{standalone: true}">
              <small class="field-help">Version tag can be changed at any time.</small>
            </div>

            <hr class="section-divider">

            <div class="field-list-header">
              <h4>Fields</h4>
              <button class="add-field-btn" (click)="showAddFieldEditor()" *ngIf="!isFieldEditorVisible">
                <mat-icon>add</mat-icon> Add Field
              </button>
            </div>
            
            <div class="field-list" cdkDropList (cdkDropListDropped)="dropField($event)">
              <ng-container *ngFor="let field of schema.fields; let i = index">
                <div class="field-item" cdkDrag>
                  <div class="drag-handle" cdkDragHandle matTooltip="Drag to reorder">
                    <mat-icon>drag_indicator</mat-icon>
                  </div>
                  <div>
                    <strong class="field-label">{{ field.label }}</strong>
                    <span class="field-meta">{{ field.key }} &middot; {{ field.type }}</span>
                  </div>
                  <div class="field-actions">
                    <button (click)="editField(i)" mat-icon-button matTooltip="Edit Field">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button class="action-duplicate" (click)="duplicateField(i)" mat-icon-button matTooltip="Duplicate Field">
                      <mat-icon>content_copy</mat-icon>
                    </button>
                    <button class="action-delete" (click)="removeField(i)" mat-icon-button matTooltip="Remove Field">
                      <mat-icon>delete_outline</mat-icon>
                    </button>
                  </div>
                </div>
                <!-- Render the field editor directly below the field being edited -->
                <div *ngIf="isFieldEditorVisible && currentFieldIndex === i" class="field-editor-form card">
                  <h5 class="field-editor-title">Edit Field</h5>
                  <form [formGroup]="fieldForm" class="field-form-grid">
                    <!-- Basic Info Section -->
                    <div class="section-heading span-2"><mat-icon>info</mat-icon> Basic Info</div>
                    <div class="form-field span-2">
                      <label>Field Label <span class="required-asterisk">*</span></label>
                      <input formControlName="label" placeholder="Visible label (e.g., 'First Name')" />
                    </div>
                    <div class="form-field">
                      <label>Field Key <span class="required-asterisk">*</span></label>
                      <input formControlName="key" placeholder="unique_key" [disabled]="currentFieldIndex !== null && !isDuplicatedEdit">
                      <div *ngIf="fieldForm.get('key')?.invalid && fieldForm.get('key')?.touched" class="error-message">Key is required and must be alphanumeric/underscore.</div>
                    </div>
                    <div class="form-field" style="margin-left: 1.25rem;">
                      <label>Field Type</label>
                      <div class="type-select-group" style="position: relative; display: flex; align-items: center;">
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'text'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          text_fields
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'number'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          pin
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'email'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          email
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'boolean'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          toggle_on
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'dropdown'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          arrow_drop_down_circle
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'mcq_single'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          radio_button_checked
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'mcq_multiple'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          check_box
                        </mat-icon>
                        <mat-icon *ngIf="fieldForm.get('type')?.value === 'keyvalue'" 
                                  style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                          vpn_key
                        </mat-icon>
                        <select formControlName="type" 
                                [disabled]="fieldForm.get('environmentSpecific')?.value"
                                style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 3rem; border: 1px solid #ced4da; border-radius: 4px; background-color: white; font-size: 0.875rem;">
                          <option value="text">Text</option>
                          <option value="number">Number</option>
                          <option value="email">Email</option>
                          <option value="boolean">Boolean</option>
                          <option value="dropdown">Dropdown</option>
                          <option value="mcq_single">MCQ (Single Select)</option>
                          <option value="mcq_multiple">MCQ (Multiple Select)</option>
                          <option value="keyvalue">Key-Value</option>
                        </select>
                      </div>
                    </div>

                    <!-- Field Settings Section -->
                    <div class="section-heading span-2"><mat-icon>tune</mat-icon> Field Settings</div>
                    <div class="form-field span-2">
                      <label>Placeholder / Help Text</label>
                      <input formControlName="placeholder" placeholder="Help text inside the input or for checkbox" />
                    </div>
                    
                    <div class="form-field">
                      <label>Default Value</label>
                      
                      <!-- For environment specific fields -->
                      <ng-container *ngIf="fieldForm.get('environmentSpecific')?.value; else singleDefaultValue">
                        <ng-container [ngSwitch]="fieldForm.get('type')?.value">
                          
                          <!-- Text - Individual environment inputs -->
                          <ng-container *ngSwitchCase="'text'">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                                <input matInput [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                       placeholder="Default text for PROD" 
                                       style="flex: 1;" />
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                                <input matInput [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                       placeholder="Default text for DEV" 
                                       style="flex: 1;" />
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">COB:</label>
                                <input matInput [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                       placeholder="Default text for COB" 
                                       style="flex: 1;" />
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- Number - Individual environment inputs -->
                          <ng-container *ngSwitchCase="'number'">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                                <input matInput type="number" [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                       placeholder="Default number for PROD" 
                                       style="flex: 1;" />
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                                <input matInput type="number" [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                       placeholder="Default number for DEV" 
                                       style="flex: 1;" />
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">COB:</label>
                                <input matInput type="number" [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                       placeholder="Default number for COB" 
                                       style="flex: 1;" />
                              </div>
                            </div>
                          </ng-container>

                          <!-- Email - Individual environment inputs -->
                          <ng-container *ngSwitchCase="'email'">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                                <input matInput type="email" [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                       placeholder="Default email for PROD" 
                                       style="flex: 1;" />
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                                <input matInput type="email" [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                       placeholder="Default email for DEV" 
                                       style="flex: 1;" />
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">COB:</label>
                                <input matInput type="email" [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                       (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                       placeholder="Default email for COB" 
                                       style="flex: 1;" />
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- Boolean - Individual environment selects -->
                          <ng-container *ngSwitchCase="'boolean'">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default --</option>
                                  <option [value]="true">True</option>
                                  <option [value]="false">False</option>
                                </select>
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default --</option>
                                  <option [value]="true">True</option>
                                  <option [value]="false">False</option>
                                </select>
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">COB:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default --</option>
                                  <option [value]="true">True</option>
                                  <option [value]="false">False</option>
                                </select>
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- Dropdown - Individual environment selects -->
                          <ng-container *ngSwitchCase="'dropdown'">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default Option --</option>
                                  <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                                </select>
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default Option --</option>
                                  <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                                </select>
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">COB:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default Option --</option>
                                  <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                                </select>
                              </div>
                            </div>
                          </ng-container>

                          <!-- MCQ Single - Individual environment selects -->
                          <ng-container *ngSwitchCase="'mcq_single'">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default Option --</option>
                                  <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                                </select>
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default Option --</option>
                                  <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                                </select>
                              </div>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="min-width: 60px; font-weight: 600;">COB:</label>
                                <select [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                        (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                        style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                  <option value="">-- Select Default Option --</option>
                                  <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                                </select>
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- MCQ Multiple - Individual environment multi-selects -->
                          <ng-container *ngSwitchCase="'mcq_multiple'">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                              <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">PROD Environment:</div>
                                <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" [value]="opt.value.value" 
                                           (change)="onEnvDefaultMultiChange($event, opt.value.value, 'PROD')" 
                                           [checked]="fieldForm.value.defaultValue?.PROD?.includes(opt.value.value)">
                                    <span>{{ opt.value.label }}</span>
                                  </label>
                                </div>
                              </div>
                              <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">DEV Environment:</div>
                                <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" [value]="opt.value.value" 
                                           (change)="onEnvDefaultMultiChange($event, opt.value.value, 'DEV')" 
                                           [checked]="fieldForm.value.defaultValue?.DEV?.includes(opt.value.value)">
                                    <span>{{ opt.value.label }}</span>
                                  </label>
                                </div>
                              </div>
                              <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">COB Environment:</div>
                                <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" [value]="opt.value.value" 
                                           (change)="onEnvDefaultMultiChange($event, opt.value.value, 'COB')" 
                                           [checked]="fieldForm.value.defaultValue?.COB?.includes(opt.value.value)">
                                    <span>{{ opt.value.label }}</span>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- Key-Value - No default value input -->
                          <ng-container *ngSwitchCase="'keyvalue'">
                            <div style="padding: 12px; background: #e9ecef; border-radius: 4px; color: #6c757d; font-style: italic;">
                              Key-Value fields don't have default values. Use "Default Keys" section below to set initial keys.
                            </div>
                          </ng-container>
                        </ng-container>
                      </ng-container>
                      
                      <!-- For non-environment specific fields -->
                      <ng-template #singleDefaultValue>
                        <ng-container [ngSwitch]="fieldForm.get('type')?.value">
                          <!-- Text, Number, Email - Single text inputs -->
                          <ng-container *ngSwitchCase="'text'">
                            <input matInput formControlName="defaultValue" placeholder="Default text value" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'number'">
                            <input matInput type="number" formControlName="defaultValue" placeholder="Default number value" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'email'">
                            <input matInput type="email" formControlName="defaultValue" placeholder="Default email value" />
                          </ng-container>
                          
                          <!-- Boolean - Single boolean select -->
                          <ng-container *ngSwitchCase="'boolean'">
                            <select formControlName="defaultValue" 
                                    style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default --</option>
                              <option [value]="true">True</option>
                              <option [value]="false">False</option>
                            </select>
                          </ng-container>
                          
                          <!-- Dropdown - Single option select -->
                          <ng-container *ngSwitchCase="'dropdown'">
                            <select formControlName="defaultValue" 
                                    style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </ng-container>
                          
                          <!-- MCQ Single - Single option select -->
                          <ng-container *ngSwitchCase="'mcq_single'">
                            <select formControlName="defaultValue" 
                                    style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </ng-container>
                          
                          <!-- MCQ Multiple - Multi-select checkboxes -->
                          <ng-container *ngSwitchCase="'mcq_multiple'">
                            <div style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                              <div style="font-size: 0.9rem; margin-bottom: 8px; color: #6c757d;">Select default options:</div>
                              <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                  <input type="checkbox" [value]="opt.value.value" 
                                         (change)="onDefaultMultiChange($event, opt.value.value)" 
                                         [checked]="fieldForm.value.defaultValue?.includes(opt.value.value)">
                                  <span>{{ opt.value.label }}</span>
                                </label>
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- Key-Value - No default value input -->
                          <ng-container *ngSwitchCase="'keyvalue'">
                            <div style="padding: 12px; background: #e9ecef; border-radius: 4px; color: #6c757d; font-style: italic;">
                              Key-Value fields don't have default values. Use "Default Keys" section below to set initial keys.
                            </div>
                          </ng-container>
                        </ng-container>
                      </ng-template>
                    </div>
                    
                    <div class="form-field" *ngIf="fieldForm.get('type')?.value === 'text'">
                      
                    <label>Validation Regex <mat-icon matTooltip="Pattern the input must match (e.g., ^[a-zA-Z]+$)">help_outline</mat-icon></label>
                      <div class="input-with-button">
                        <input formControlName="regex" placeholder="e.g., ^[a-zA-Z]+$">
                        <button type="button" mat-icon-button (click)="regexHelperVisible = !regexHelperVisible" matTooltip="Show Regex Helper">
                          <mat-icon>auto_fix_high</mat-icon>
                        </button>
                      </div>
                      <div *ngIf="regexHelperVisible" class="regex-helper-dropdown card">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Regex Helper</div>
                        <div *ngFor="let opt of regexOptions" class="regex-option">
                          <button type="button" (click)="fieldForm.get('regex')?.setValue(opt.value); regexHelperVisible = false;">
                            {{ opt.label }}
                            <span>{{ opt.value }}</span>
                          </button>
                        </div>
                        <button type="button" (click)="regexHelperVisible = false" class="close-regex-btn">Close</button>
                      </div>
                    </div>
                    
                    <div class="small-checkbox-group span-2" style="display: flex; gap: 1.2rem; align-items: center; margin-bottom: 1.2rem;">
                      <mat-checkbox formControlName="required" color="primary" style="margin:0; font-size:0.97rem;">
                        Required Field <mat-icon matTooltip="User must fill this field">help_outline</mat-icon>
                      </mat-checkbox>
                      <mat-checkbox formControlName="editable" color="primary" style="margin:0; font-size:0.97rem;">
                        User Editable <mat-icon matTooltip="If unchecked, field is visible but not editable">help_outline</mat-icon>
                      </mat-checkbox>
                      <mat-checkbox formControlName="environmentSpecific" color="primary" style="margin:0; font-size:0.97rem;">
                        Environment Specific <mat-icon matTooltip="If checked, field will have PROD/DEV/COB subfields">help_outline</mat-icon>
                      </mat-checkbox>
                    </div>

                    <!-- Dropdown Options Section -->
                    <div *ngIf="fieldForm.get('type')?.value === 'dropdown'" class="options-editor span-2">
                      <h6 class="section-heading"><mat-icon>list</mat-icon> Dropdown Options</h6>
                      <div formArrayName="options">
                        <div *ngFor="let option of options.controls; let i = index" [formGroupName]="i" class="option-item">
                          <input formControlName="label" placeholder="Option Text" (input)="syncOptionLabelValue(i)"
                                style="flex: 1; width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; outline: none; transition: border-color 0.15s ease-in-out;"
                                onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 2px rgba(0,123,255,0.25)'"
                                onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none'">
                          <button type="button" class="action-delete" (click)="removeOption(i)" mat-icon-button matTooltip="Remove Option"
                                  style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.15s ease-in-out; display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;"
                                  onmouseover="this.style.backgroundColor='#f8d7da'"
                                  onmouseout="this.style.backgroundColor='transparent'">
                            <mat-icon style="font-size: 18px;">remove_circle_outline</mat-icon>
                          </button>
                        </div>
                        <div *ngIf="options.length === 0" class="no-options-message">No options added yet.</div>
                      </div>
                      <button type="button" class="add-option-btn" (click)="addOption()">
                        <mat-icon>add</mat-icon> Add Option
                      </button>
                    </div>

                    <!-- MCQ Options Section -->
                    <div *ngIf="fieldForm.get('type')?.value === 'mcq_single' || fieldForm.get('type')?.value === 'mcq_multiple'" class="options-editor span-2">
                      <h6 class="section-heading"><mat-icon>list</mat-icon> MCQ Options</h6>
                      <div formArrayName="options">
                        <div *ngFor="let option of options.controls; let i = index" [formGroupName]="i" class="option-item">
                          <input formControlName="label" placeholder="Option Text" (input)="syncOptionLabelValue(i)"
                                style="flex: 1; width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; outline: none; transition: border-color 0.15s ease-in-out;"
                                onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 2px rgba(0,123,255,0.25)'"
                                onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none'">
                          <button type="button" class="action-delete" (click)="removeOption(i)" mat-icon-button matTooltip="Remove Option"
                                  style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.15s ease-in-out; display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;"
                                  onmouseover="this.style.backgroundColor='#f8d7da'"
                                  onmouseout="this.style.backgroundColor='transparent'">
                            <mat-icon style="font-size: 18px;">remove_circle_outline</mat-icon>
                          </button>
                        </div>
                        <div *ngIf="options.length === 0" class="no-options-message">No options added yet.</div>
                      </div>
                      <button type="button" class="add-option-btn" (click)="addOption()">
                        <mat-icon>add</mat-icon> Add Option
                      </button>
                    </div>

                    <!-- Key-Value Pairs Section -->
                    <div *ngIf="fieldForm.get('type')?.value === 'keyvalue'" class="form-field span-2">
                      <label>Default Keys (comma separated)</label>
                      <input formControlName="initialKeys" placeholder="e.g. key1, key2, key3">
                    </div>

                    <!-- Conditional Logic Section -->
                    <div class="section-heading span-2"><mat-icon>visibility</mat-icon> Conditional Logic</div>
                    <div class="form-field span-2">
                      <label>Visible If (Show this field only if another field has a specific value)</label>
                      <div class="conditional-logic-row" style="display: flex; gap: 0.5rem; align-items: center;">
                        <select [(ngModel)]="visibleIfKey" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                          <option [ngValue]="null">-- Select Field --</option>
                          <option *ngFor="let f of schema.fields" [ngValue]="f.key" [disabled]="f.key === fieldForm.value.key">{{ f.label }}</option>
                        </select>
                        <ng-container *ngIf="visibleIfKey">
                          <ng-container [ngSwitch]="getFieldType(visibleIfKey)">
                            <select *ngSwitchCase="'dropdown'" [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(visibleIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <select *ngSwitchCase="'mcq_single'" [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(visibleIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <div *ngSwitchCase="'mcq_multiple'" style="flex:1; display:flex; flex-wrap:wrap; gap:0.5rem; min-width: 250px;">
                              <label *ngFor="let opt of getFieldOptions(visibleIfKey)">
                                <input type="checkbox" [value]="opt.value" (change)="onMultiCondChange($event, 'visible')" [checked]="isArray(visibleIfValue) && visibleIfValue.includes(opt.value)"> {{ opt.label }}
                              </label>
                            </div>
                            <select *ngSwitchCase="'boolean'" [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option [ngValue]="true">True</option>
                              <option [ngValue]="false">False</option>
                            </select>
                            <input *ngSwitchDefault [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" placeholder="Value" style="flex:1; min-width: 250px;">
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                    <div class="form-field span-2">
                      <label>Mandatory If (Make this field required only if another field has a specific value)</label>
                      <div class="conditional-logic-row" style="display: flex; gap: 0.5rem; align-items: center;">
                        <select [(ngModel)]="mandatoryIfKey" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                          <option [ngValue]="null">-- Select Field --</option>
                          <option *ngFor="let f of schema.fields" [ngValue]="f.key" [disabled]="f.key === fieldForm.value.key">{{ f.label }}</option>
                        </select>
                        <ng-container *ngIf="mandatoryIfKey">
                          <ng-container [ngSwitch]="getFieldType(mandatoryIfKey)">
                            <select *ngSwitchCase="'dropdown'" [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(mandatoryIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <select *ngSwitchCase="'mcq_single'" [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(mandatoryIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <div *ngSwitchCase="'mcq_multiple'" style="flex:1; display:flex; flex-wrap:wrap; gap:0.5rem; min-width: 250px;">
                              <label *ngFor="let opt of getFieldOptions(mandatoryIfKey)">
                                <input type="checkbox" [value]="opt.value" (change)="onMultiCondChange($event, 'mandatory')" [checked]="isArray(mandatoryIfValue) && mandatoryIfValue.includes(opt.value)"> {{ opt.label }}
                              </label>
                            </div>
                            <select *ngSwitchCase="'boolean'" [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option [ngValue]="true">True</option>
                              <option [ngValue]="false">False</option>
                            </select>
                            <input *ngSwitchDefault [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" placeholder="Value" style="flex:1; min-width: 250px;">
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>

                    <!-- Save/Cancel Actions -->
                    <div class="field-editor-actions span-2">
                      <button type="button" (click)="isFieldEditorVisible = false" class="secondary">Cancel</button>
                      <button type="button" (click)="saveField()" [disabled]="fieldForm.invalid" mat-raised-button color="primary">
                        <mat-icon>save</mat-icon> Save Field
                      </button>
                    </div>
                  </form>
                </div>
              </ng-container>
              <p *ngIf="schema.fields.length === 0" class="no-fields-message">No fields added yet.</p>
            </div>

            <!-- Only show add field editor at the end if adding a new field -->
            <div *ngIf="isFieldEditorVisible && currentFieldIndex === null" class="field-editor-form card">
              <h5 class="field-editor-title">Add New Field</h5>
              <form [formGroup]="fieldForm" class="field-form-grid">
                <!-- Basic Info Section -->
                <div class="section-heading span-2"><mat-icon>info</mat-icon> Basic Info</div>
                <div class="form-field span-2">
                  <label>Field Label <span class="required-asterisk">*</span></label>
                  <input formControlName="label" placeholder="Visible label (e.g., 'First Name')" />
                </div>
                <div class="form-field">
                  <label>Field Key <span class="required-asterisk">*</span></label>
                  <input formControlName="key" placeholder="unique_key" [disabled]="currentFieldIndex !== null && !isDuplicatedEdit">
                  <div *ngIf="fieldForm.get('key')?.invalid && fieldForm.get('key')?.touched" class="error-message">Key is required and must be alphanumeric/underscore.</div>
                </div>
                <div class="form-field" style="margin-left: 1.25rem;">
                  <label>Field Type</label>
                  <div class="type-select-group" style="position: relative; display: flex; align-items: center;">
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'text'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      text_fields
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'number'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      pin
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'email'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      email
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'boolean'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      toggle_on
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'dropdown'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      arrow_drop_down_circle
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'mcq_single'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      radio_button_checked
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'mcq_multiple'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      check_box
                    </mat-icon>
                    <mat-icon *ngIf="fieldForm.get('type')?.value === 'keyvalue'" 
                              style="position: absolute; left: 0.75rem; z-index: 1; pointer-events: none; color: #6c757d;">
                      vpn_key
                    </mat-icon>
                    <select formControlName="type" 
                            [disabled]="fieldForm.get('environmentSpecific')?.value"
                            style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 3rem; border: 1px solid #ced4da; border-radius: 4px; background-color: white; font-size: 0.875rem;">
                      <option value="text">Text</option>
                      <option value="number">Number</option>
                      <option value="email">Email</option>
                      <option value="boolean">Boolean</option>
                      <option value="dropdown">Dropdown</option>
                      <option value="mcq_single">MCQ (Single Select)</option>
                      <option value="mcq_multiple">MCQ (Multiple Select)</option>
                      <option value="keyvalue">Key-Value</option>
                    </select>
                  </div>
                </div>

                <!-- Field Settings Section -->
                <div class="section-heading span-2"><mat-icon>tune</mat-icon> Field Settings</div>
                <div class="form-field span-2">
                  <label>Placeholder / Help Text</label>
                  <input formControlName="placeholder" placeholder="Help text inside the input or for checkbox" />
                </div>
                
                <div class="form-field">
                  <label>Default Value</label>
                  
                  <!-- For environment specific fields -->
                  <ng-container *ngIf="fieldForm.get('environmentSpecific')?.value; else singleDefaultValue">
                    <ng-container [ngSwitch]="fieldForm.get('type')?.value">
                      
                      <!-- Text - Individual environment inputs -->
                      <ng-container *ngSwitchCase="'text'">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                            <input matInput [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                   placeholder="Default text for PROD" 
                                   style="flex: 1;" />
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                            <input matInput [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                   placeholder="Default text for DEV" 
                                   style="flex: 1;" />
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">COB:</label>
                            <input matInput [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                   placeholder="Default text for COB" 
                                   style="flex: 1;" />
                          </div>
                        </div>
                      </ng-container>
                      
                      <!-- Number - Individual environment inputs -->
                      <ng-container *ngSwitchCase="'number'">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                            <input matInput type="number" [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                   placeholder="Default number for PROD" 
                                   style="flex: 1;" />
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                            <input matInput type="number" [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                   placeholder="Default number for DEV" 
                                   style="flex: 1;" />
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">COB:</label>
                            <input matInput type="number" [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                   placeholder="Default number for COB" 
                                   style="flex: 1;" />
                          </div>
                        </div>
                      </ng-container>

                      <!-- Email - Individual environment inputs -->
                      <ng-container *ngSwitchCase="'email'">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                            <input matInput type="email" [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                   placeholder="Default email for PROD" 
                                   style="flex: 1;" />
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                            <input matInput type="email" [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                   placeholder="Default email for DEV" 
                                   style="flex: 1;" />
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">COB:</label>
                            <input matInput type="email" [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                   (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                   placeholder="Default email for COB" 
                                   style="flex: 1;" />
                          </div>
                        </div>
                      </ng-container>
                      
                      <!-- Boolean - Individual environment selects -->
                      <ng-container *ngSwitchCase="'boolean'">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default --</option>
                              <option [value]="true">True</option>
                              <option [value]="false">False</option>
                            </select>
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default --</option>
                              <option [value]="true">True</option>
                              <option [value]="false">False</option>
                            </select>
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">COB:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default --</option>
                              <option [value]="true">True</option>
                              <option [value]="false">False</option>
                            </select>
                          </div>
                        </div>
                      </ng-container>
                      
                      <!-- Dropdown - Individual environment selects -->
                      <ng-container *ngSwitchCase="'dropdown'">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">COB:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </div>
                        </div>
                      </ng-container>

                      <!-- MCQ Single - Individual environment selects -->
                      <ng-container *ngSwitchCase="'mcq_single'">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">PROD:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.PROD" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('PROD', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">DEV:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.DEV" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('DEV', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </div>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 60px; font-weight: 600;">COB:</label>
                            <select [ngModel]="fieldForm.value.defaultValue?.COB" [ngModelOptions]="{standalone: true}" 
                                    (ngModelChange)="setEnvDefaultValue('COB', $event)" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                              <option value="">-- Select Default Option --</option>
                              <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                            </select>
                          </div>
                        </div>
                      </ng-container>
                      
                      <!-- MCQ Multiple - Individual environment multi-selects -->
                      <ng-container *ngSwitchCase="'mcq_multiple'">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                          <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">PROD Environment:</div>
                            <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" [value]="opt.value.value" 
                                       (change)="onEnvDefaultMultiChange($event, opt.value.value, 'PROD')" 
                                       [checked]="fieldForm.value.defaultValue?.PROD?.includes(opt.value.value)">
                                <span>{{ opt.value.label }}</span>
                              </label>
                            </div>
                          </div>
                          <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">DEV Environment:</div>
                            <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" [value]="opt.value.value" 
                                       (change)="onEnvDefaultMultiChange($event, opt.value.value, 'DEV')" 
                                       [checked]="fieldForm.value.defaultValue?.DEV?.includes(opt.value.value)">
                                <span>{{ opt.value.label }}</span>
                              </label>
                            </div>
                          </div>
                          <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">COB Environment:</div>
                            <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" [value]="opt.value.value" 
                                       (change)="onEnvDefaultMultiChange($event, opt.value.value, 'COB')" 
                                       [checked]="fieldForm.value.defaultValue?.COB?.includes(opt.value.value)">
                                <span>{{ opt.value.label }}</span>
                              </label>
                            </div>
                          </div>
                        </div>
                      </ng-container>
                      
                      <!-- Key-Value - No default value input -->
                      <ng-container *ngSwitchCase="'keyvalue'">
                        <div style="padding: 12px; background: #e9ecef; border-radius: 4px; color: #6c757d; font-style: italic;">
                          Key-Value fields don't have default values. Use "Default Keys" section below to set initial keys.
                        </div>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                  
                  <!-- For non-environment specific fields -->
                  <ng-template #singleDefaultValue>
                    <ng-container [ngSwitch]="fieldForm.get('type')?.value">
                      <!-- Text, Number, Email - Single text inputs -->
                      <ng-container *ngSwitchCase="'text'">
                        <input matInput formControlName="defaultValue" placeholder="Default text value" />
                      </ng-container>
                      <ng-container *ngSwitchCase="'number'">
                        <input matInput type="number" formControlName="defaultValue" placeholder="Default number value" />
                      </ng-container>
                      <ng-container *ngSwitchCase="'email'">
                        <input matInput type="email" formControlName="defaultValue" placeholder="Default email value" />
                      </ng-container>
                      
                      <!-- Boolean - Single boolean select -->
                      <ng-container *ngSwitchCase="'boolean'">
                        <select formControlName="defaultValue" 
                                style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                          <option value="">-- Select Default --</option>
                          <option [value]="true">True</option>
                          <option [value]="false">False</option>
                        </select>
                      </ng-container>
                      
                      <!-- Dropdown - Single option select -->
                      <ng-container *ngSwitchCase="'dropdown'">
                        <select formControlName="defaultValue" 
                                style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                          <option value="">-- Select Default Option --</option>
                          <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                        </select>
                      </ng-container>
                      
                      <!-- MCQ Single - Single option select -->
                      <ng-container *ngSwitchCase="'mcq_single'">
                        <select formControlName="defaultValue" 
                                style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                          <option value="">-- Select Default Option --</option>
                          <option *ngFor="let opt of options.controls" [value]="opt.value.value">{{ opt.value.label }}</option>
                        </select>
                      </ng-container>
                      
                      <!-- MCQ Multiple - Multi-select checkboxes -->
                      <ng-container *ngSwitchCase="'mcq_multiple'">
                        <div style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background: #f8f9fa;">
                          <div style="font-size: 0.9rem; margin-bottom: 8px; color: #6c757d;">Select default options:</div>
                          <div *ngFor="let opt of options.controls" style="margin-bottom: 4px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input type="checkbox" [value]="opt.value.value" 
                                     (change)="onDefaultMultiChange($event, opt.value.value)" 
                                     [checked]="fieldForm.value.defaultValue?.includes(opt.value.value)">
                              <span>{{ opt.value.label }}</span>
                            </label>
                          </div>
                        </div>
                      </ng-container>
                      
                      <!-- Key-Value - No default value input -->
                      <ng-container *ngSwitchCase="'keyvalue'">
                        <div style="padding: 12px; background: #e9ecef; border-radius: 4px; color: #6c757d; font-style: italic;">
                          Key-Value fields don't have default values. Use "Default Keys" section below to set initial keys.
                        </div>
                      </ng-container>
                    </ng-container>
                  </ng-template>
                </div>
                
                <div class="form-field" *ngIf="fieldForm.get('type')?.value === 'text'">
                  <label>Validation Regex <mat-icon matTooltip="Pattern the input must match (e.g., ^[a-zA-Z]+$)">help_outline</mat-icon></label>
                  <div class="input-with-button">
                    <input formControlName="regex" placeholder="e.g., ^[a-zA-Z]+$">
                    <button type="button" mat-icon-button (click)="regexHelperVisible = !regexHelperVisible" matTooltip="Show Regex Helper">
                      <mat-icon>auto_fix_high</mat-icon>
                    </button>
                  </div>
                  <div *ngIf="regexHelperVisible" class="regex-helper-dropdown card">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Regex Helper</div>
                    <div *ngFor="let opt of regexOptions" class="regex-option">
                      <button type="button" (click)="fieldForm.get('regex')?.setValue(opt.value); regexHelperVisible = false;">
                        {{ opt.label }}
                        <span>{{ opt.value }}</span>
                      </button>
                    </div>
                    <button type="button" (click)="regexHelperVisible = false" class="close-regex-btn">Close</button>
                  </div>
                </div>
                
                <div class="small-checkbox-group span-2" style="display: flex; gap: 1.2rem; align-items: center; margin-bottom: 1.2rem;">
                  <mat-checkbox formControlName="required" color="primary" style="margin:0; font-size:0.97rem;">
                    Required Field <mat-icon matTooltip="User must fill this field">help_outline</mat-icon>
                  </mat-checkbox>
                  <mat-checkbox formControlName="editable" color="primary" style="margin:0; font-size:0.97rem;">
                    User Editable <mat-icon matTooltip="If unchecked, field is visible but not editable">help_outline</mat-icon>
                  </mat-checkbox>
                  <mat-checkbox formControlName="environmentSpecific" color="primary" style="margin:0; font-size:0.97rem;">
                    Environment Specific <mat-icon matTooltip="If checked, field will have PROD/DEV/COB subfields">help_outline</mat-icon>
                  </mat-checkbox>
                </div>

                <!-- Dropdown Options Section -->
                <div *ngIf="fieldForm.get('type')?.value === 'dropdown'" class="options-editor span-2">
                  <h6 class="section-heading"><mat-icon>list</mat-icon> Dropdown Options</h6>
                  <div formArrayName="options">
                    <div *ngFor="let option of options.controls; let i = index" [formGroupName]="i" class="option-item">
                      <input formControlName="label" placeholder="Option Text" (input)="syncOptionLabelValue(i)"
                            style="flex: 1; width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; outline: none; transition: border-color 0.15s ease-in-out;"
                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 2px rgba(0,123,255,0.25)'"
                            onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none'">
                      <button type="button" class="action-delete" (click)="removeOption(i)" mat-icon-button matTooltip="Remove Option"
                              style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.15s ease-in-out; display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;"
                              onmouseover="this.style.backgroundColor='#f8d7da'"
                              onmouseout="this.style.backgroundColor='transparent'">
                        <mat-icon style="font-size: 18px;">remove_circle_outline</mat-icon>
                      </button>
                    </div>
                    <div *ngIf="options.length === 0" class="no-options-message">No options added yet.</div>
                  </div>
                  <button type="button" class="add-option-btn" (click)="addOption()">
                    <mat-icon>add</mat-icon> Add Option
                  </button>
                </div>

                <!-- MCQ Options Section -->
                <div *ngIf="fieldForm.get('type')?.value === 'mcq_single' || fieldForm.get('type')?.value === 'mcq_multiple'" class="options-editor span-2">
                  <h6 class="section-heading"><mat-icon>list</mat-icon> MCQ Options</h6>
                  <div formArrayName="options">
                    <div *ngFor="let option of options.controls; let i = index" [formGroupName]="i" class="option-item">
                      <input formControlName="label" placeholder="Option Text" (input)="syncOptionLabelValue(i)"
                            style="flex: 1; width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; outline: none; transition: border-color 0.15s ease-in-out;"
                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 2px rgba(0,123,255,0.25)'"
                            onblur="this.style.borderColor='#ced4da'; this.style.boxShadow='none'">
                      <button type="button" class="action-delete" (click)="removeOption(i)" mat-icon-button matTooltip="Remove Option"
                              style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.15s ease-in-out; display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px;"
                              onmouseover="this.style.backgroundColor='#f8d7da'"
                              onmouseout="this.style.backgroundColor='transparent'">
                        <mat-icon style="font-size: 18px;">remove_circle_outline</mat-icon>
                      </button>
                    </div>
                    <div *ngIf="options.length === 0" class="no-options-message">No options added yet.</div>
                  </div>
                  <button type="button" class="add-option-btn" (click)="addOption()">
                    <mat-icon>add</mat-icon> Add Option
                  </button>
                </div>

                <!-- Key-Value Pairs Section -->
                <div *ngIf="fieldForm.get('type')?.value === 'keyvalue'" class="form-field span-2">
                  <label>Default Keys (comma separated)</label>
                  <input formControlName="initialKeys" placeholder="e.g. key1, key2, key3">
                </div>



                 <!-- Conditional Logic Section -->
                    <div class="section-heading span-2"><mat-icon>visibility</mat-icon> Conditional Logic</div>
                    <div class="form-field span-2">
                      <label>Visible If (Show this field only if another field has a specific value)</label>
                      <div class="conditional-logic-row" style="display: flex; gap: 0.5rem; align-items: center;">
                        <select [(ngModel)]="visibleIfKey" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                          <option [ngValue]="null">-- Select Field --</option>
                          <option *ngFor="let f of schema.fields" [ngValue]="f.key" [disabled]="f.key === fieldForm.value.key">{{ f.label }}</option>
                        </select>
                        <ng-container *ngIf="visibleIfKey">
                          <ng-container [ngSwitch]="getFieldType(visibleIfKey)">
                            <select *ngSwitchCase="'dropdown'" [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(visibleIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <select *ngSwitchCase="'mcq_single'" [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(visibleIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <div *ngSwitchCase="'mcq_multiple'" style="flex:1; display:flex; flex-wrap:wrap; gap:0.5rem; min-width: 250px;">
                              <label *ngFor="let opt of getFieldOptions(visibleIfKey)">
                                <input type="checkbox" [value]="opt.value" (change)="onMultiCondChange($event, 'visible')" [checked]="isArray(visibleIfValue) && visibleIfValue.includes(opt.value)"> {{ opt.label }}
                              </label>
                            </div>
                            <select *ngSwitchCase="'boolean'" [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option [ngValue]="true">True</option>
                              <option [ngValue]="false">False</option>
                            </select>
                            <input *ngSwitchDefault [(ngModel)]="visibleIfValue" [ngModelOptions]="{standalone: true}" placeholder="Value" style="flex:1; min-width: 250px;">
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                    <div class="form-field span-2">
                      <label>Mandatory If (Make this field required only if another field has a specific value)</label>
                      <div class="conditional-logic-row" style="display: flex; gap: 0.5rem; align-items: center;">
                        <select [(ngModel)]="mandatoryIfKey" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                          <option [ngValue]="null">-- Select Field --</option>
                          <option *ngFor="let f of schema.fields" [ngValue]="f.key" [disabled]="f.key === fieldForm.value.key">{{ f.label }}</option>
                        </select>
                        <ng-container *ngIf="mandatoryIfKey">
                          <ng-container [ngSwitch]="getFieldType(mandatoryIfKey)">
                            <select *ngSwitchCase="'dropdown'" [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(mandatoryIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <select *ngSwitchCase="'mcq_single'" [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option *ngFor="let opt of getFieldOptions(mandatoryIfKey)" [ngValue]="opt.value">{{ opt.label }}</option>
                            </select>
                            <div *ngSwitchCase="'mcq_multiple'" style="flex:1; display:flex; flex-wrap:wrap; gap:0.5rem; min-width: 250px;">
                              <label *ngFor="let opt of getFieldOptions(mandatoryIfKey)">
                                <input type="checkbox" [value]="opt.value" (change)="onMultiCondChange($event, 'mandatory')" [checked]="isArray(mandatoryIfValue) && mandatoryIfValue.includes(opt.value)"> {{ opt.label }}
                              </label>
                            </div>
                            <select *ngSwitchCase="'boolean'" [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" style="flex:1; min-width: 250px;">
                              <option [ngValue]="true">True</option>
                              <option [ngValue]="false">False</option>
                            </select>
                            <input *ngSwitchDefault [(ngModel)]="mandatoryIfValue" [ngModelOptions]="{standalone: true}" placeholder="Value" style="flex:1; min-width: 250px;">
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>


                <!-- Save/Cancel Actions -->
                <div class="field-editor-actions span-2">
                  <button type="button" (click)="isFieldEditorVisible = false" class="secondary">Cancel</button>
                  <button type="button" (click)="saveField()" [disabled]="fieldForm.invalid" mat-raised-button color="primary">
                    <mat-icon>save</mat-icon> Save Field
                  </button>
                </div>
              </form>
            </div>
          </div>
          
              
              <div class="bottom-add-field-btn-container">
                <button class="add-field-btn" (click)="showAddFieldEditor()" *ngIf="!isFieldEditorVisible">
                  <mat-icon>add</mat-icon> Add Field
                </button>
              </div>
        </div>
      </main>
      <!-- Animated popup notification -->
      <app-animated-popup
        *ngIf="popupVisible"
        [message]="popupMessage"
        [type]="popupType"
        [visible]="popupVisible"
        (closed)="popupVisible = false"
      ></app-animated-popup>
    </div>
